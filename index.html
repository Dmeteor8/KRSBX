<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸šåŠ¡æŠ¥é”€è®°è´¦</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5', // Indigo 600
                        secondary: '#64748B', // Slate 500
                        bg: '#F8FAFC', // Slate 50
                        surface: '#FFFFFF',
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'nav': '0 -4px 20px rgba(0,0,0,0.03)'
                    }
                }
            }
        }
    </script>
    <style>
        /* éšè—æ»šåŠ¨æ¡ä½†å…è®¸æ»šåŠ¨ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* æ¨¡æ‹ŸiOSåº•éƒ¨å®‰å…¨åŒºåŸŸ */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* ç®€å•çš„æ·¡å…¥åŠ¨ç”» */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* åº•éƒ¨å¯¼èˆªæ¿€æ´»æ€ */
        .nav-item.active {
            color: #4F46E5;
        }
        .nav-item.active svg {
            stroke: #4F46E5;
        }
        
        /* è¾“å…¥æ¡†è‡ªåŠ¨å¡«å……èƒŒæ™¯è‰²ä¿®å¤ */
        input:-webkit-autofill,
        input:-webkit-autofill:hover, 
        input:-webkit-autofill:focus, 
        input:-webkit-autofill:active{
            -webkit-box-shadow: 0 0 0 30px #F8FAFC inset !important;
            -webkit-text-fill-color: #334155 !important;
            transition: background-color 5000s ease-in-out 0s;
        }
    </style>
</head>
<body class="bg-gray-200 text-slate-800 font-sans antialiased h-[100dvh] flex justify-center overflow-hidden">

    <!-- ==================== ç™»å½•/æ³¨å†Œç•Œé¢ ==================== -->
    <div id="auth-view" class="w-full max-w-md h-full bg-bg flex flex-col items-center justify-center p-6 z-50 absolute inset-0 transition-opacity duration-300">
        <div class="w-full bg-surface p-8 rounded-3xl shadow-soft border border-slate-100 fade-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-indigo-100 rounded-2xl mx-auto flex items-center justify-center text-primary text-3xl mb-4 shadow-inner">
                    ğŸ’°
                </div>
                <h1 class="text-2xl font-bold text-slate-900">æŠ¥é”€è®°è´¦</h1>
                <p class="text-sm text-slate-500 mt-1">è¯·ç™»å½•ä»¥åŒæ­¥æ‚¨çš„æ•°æ®</p>
            </div>

            <!-- Tab åˆ‡æ¢ -->
            <div class="flex bg-slate-100 p-1 rounded-xl mb-6">
                <button onclick="switchAuthTab('login')" id="tab-login-btn" class="flex-1 py-2 text-sm font-bold rounded-lg bg-white text-primary shadow-sm transition-all">ç™»å½•</button>
                <button onclick="switchAuthTab('register')" id="tab-register-btn" class="flex-1 py-2 text-sm font-bold rounded-lg text-slate-500 hover:text-slate-700 transition-all">æ³¨å†Œ</button>
            </div>

            <!-- ç™»å½•è¡¨å• -->
            <div id="form-login" class="space-y-4">
                <div>
                    <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">ç”¨æˆ·å</label>
                    <input type="text" id="login-username" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-primary/20 transition-all" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">å¯†ç </label>
                    <input type="password" id="login-password" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-primary/20 transition-all" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <button onclick="handleLogin()" class="w-full py-3.5 rounded-xl bg-primary text-white font-bold shadow-lg shadow-indigo-500/30 hover:bg-indigo-700 transition-all active:scale-95 mt-2">
                    ç«‹å³ç™»å½•
                </button>
            </div>

            <!-- æ³¨å†Œè¡¨å• (é»˜è®¤éšè—) -->
            <div id="form-register" class="space-y-4 hidden">
                <div>
                    <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">è®¾ç½®ç”¨æˆ·å</label>
                    <input type="text" id="reg-username" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-primary/20 transition-all" placeholder="ç”¨äºç™»å½•">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">è®¾ç½®å¯†ç </label>
                    <input type="password" id="reg-password" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-primary/20 transition-all" placeholder="è‡³å°‘6ä½å­—ç¬¦">
                </div>
                <button onclick="handleRegister()" class="w-full py-3.5 rounded-xl bg-emerald-500 text-white font-bold shadow-lg shadow-emerald-500/30 hover:bg-emerald-600 transition-all active:scale-95 mt-2">
                    åˆ›å»ºè´¦å·
                </button>
            </div>
            
            <div id="auth-msg" class="text-center text-xs mt-4 h-4 text-red-500 font-medium"></div>
        </div>
        <p class="mt-8 text-xs text-slate-400">æ•°æ®å­˜å‚¨äº LeanCloud äº‘ç«¯</p>
    </div>

    <!-- ==================== ä¸»åº”ç”¨ç•Œé¢ (ç™»å½•åæ˜¾ç¤º) ==================== -->
    <div id="app-view" class="w-full max-w-md bg-bg h-full relative flex flex-col shadow-2xl overflow-hidden hidden">
        
        <!-- é¡¶éƒ¨ Header -->
        <header class="bg-surface px-6 py-4 flex justify-between items-center shadow-sm z-10 sticky top-0">
            <div>
                <h1 class="text-xl font-bold text-slate-900 tracking-tight">æŠ¥é”€è®°è´¦</h1>
                <p class="text-xs text-slate-500" id="headerDate">åŠ è½½ä¸­...</p>
            </div>
            <div class="w-8 h-8 rounded-full bg-indigo-50 flex items-center justify-center text-primary">
                ğŸ’°
            </div>
        </header>

        <!-- ä¸»å†…å®¹åŒºåŸŸ (å¯æ»šåŠ¨) -->
        <main class="flex-1 overflow-y-auto no-scrollbar p-5 pb-24 relative" id="mainContainer">
            
            <!-- 1. è®°è´¦é¡µé¢ -->
            <div id="page-entry" class="page space-y-5 fade-in">
                <!-- æ—¥æœŸå¡ç‰‡ -->
                <div class="bg-surface p-5 rounded-2xl shadow-soft border border-slate-100">
                    <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">æ—¥æœŸ</label>
                    <input type="date" id="recordDate" class="w-full bg-slate-50 border-none rounded-xl px-4 py-3 text-slate-700 font-medium focus:ring-2 focus:ring-primary/20 outline-none" onchange="loadPrevDayInfo()">
                    <div id="prevDayInfo" class="mt-3 text-xs text-indigo-500 bg-indigo-50 p-2 rounded-lg flex items-center gap-1">
                        <!-- åŠ¨æ€å†…å®¹ -->
                    </div>
                </div>

                <!-- 2. å…¬é‡Œæ•°å¡ç‰‡ -->
<div class="bg-surface p-5 rounded-2xl shadow-soft border border-slate-100">
    <div class="flex justify-between items-center mb-2">
        <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider">é‡Œç¨‹è®°å½•</label>
        <span class="text-xs font-bold text-primary">æ²¹è¡¥: Â¥<span id="fuelSubsidyDisplay">0.00</span></span>
    </div>
    
    <div class="grid grid-cols-2 gap-3 mb-3">
        <!-- å‡ºå‘å…¬é‡Œæ•° -->
        <div>
            <label class="text-xs text-slate-500 block mb-1">å‡ºå‘é‡Œç¨‹</label>
            <div class="relative">
                <input type="number" id="startMileage" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-lg font-bold text-slate-800 outline-none focus:ring-2 focus:ring-primary/20" placeholder="0" oninput="calculateTotalMileage()">
            </div>
        </div>
        <!-- å›ç¨‹å…¬é‡Œæ•° -->
        <div>
            <label class="text-xs text-slate-500 block mb-1">å›ç¨‹é‡Œç¨‹</label>
            <div class="relative">
                <input type="number" id="endMileage" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-lg font-bold text-slate-800 outline-none focus:ring-2 focus:ring-primary/20" placeholder="0" oninput="calculateTotalMileage()">
            </div>
        </div>
    </div>

    <!-- å½“æ—¥æ€»é‡Œç¨‹ (è‡ªåŠ¨è®¡ç®—ï¼Œåªè¯») -->
    <div class="bg-indigo-50 rounded-lg p-3 flex justify-between items-center">
        <span class="text-xs font-semibold text-indigo-600">å½“æ—¥æ€»é‡Œç¨‹</span>
        <div class="flex items-center gap-1">
            <input type="number" id="mileage" readonly class="bg-transparent text-right text-xl font-extrabold text-indigo-700 w-24 outline-none" value="0">
            <span class="text-sm font-bold text-indigo-400">km</span>
        </div>
    </div>
</div>


                <!-- å®¢æˆ·æ‹œè®¿ -->
                <div class="bg-surface p-5 rounded-2xl shadow-soft border border-slate-100">
                    <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">æ‹œè®¿å®¢æˆ· (æœ€å¤š6å®¶)</label>
                    <div id="clientsContainer" class="space-y-2 mb-3"></div>
                    <!-- === æ–°å¢ï¼šå®¢æˆ·è”æƒ³æ•°æ®åˆ—è¡¨ === -->
                    <datalist id="client-suggestions">
                     <!-- JS ä¼šè‡ªåŠ¨åœ¨è¿™é‡Œå¡«å…… <option>å†…å®¹ -->
                    </datalist>
                    <button onclick="addClientField()" class="w-full py-2 border-2 border-dashed border-slate-200 rounded-xl text-slate-400 text-sm font-medium hover:border-primary hover:text-primary transition-colors">
                        + æ·»åŠ å®¢æˆ·
                    </button>
                </div>

                <!-- è´¹ç”¨æ˜ç»†ç½‘æ ¼ -->
                <div class="bg-surface p-5 rounded-2xl shadow-soft border border-slate-100">
                    <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-4">è´¹ç”¨æ˜ç»†</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-xs text-slate-500">è¿‡è·¯è´¹</label>
                            <input type="number" id="tollFee" class="w-full bg-slate-50 rounded-lg px-3 py-2 text-sm font-medium outline-none focus:ring-1 focus:ring-primary" value="0" step="0.01">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs text-slate-500">åœè½¦è´¹</label>
                            <input type="number" id="parkingFee" class="w-full bg-slate-50 rounded-lg px-3 py-2 text-sm font-medium outline-none focus:ring-1 focus:ring-primary" value="0" step="0.01">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs text-slate-500">é«˜é“è´¹</label>
                            <input type="number" id="trainFee" class="w-full bg-slate-50 rounded-lg px-3 py-2 text-sm font-medium outline-none focus:ring-1 focus:ring-primary" value="0" step="0.01">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs text-slate-500">ä»£é©¾è´¹</label>
                            <input type="number" id="driverFee" class="w-full bg-slate-50 rounded-lg px-3 py-2 text-sm font-medium outline-none focus:ring-1 focus:ring-primary" value="0" step="0.01">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs text-slate-500">ä½å®¿è´¹</label>
                            <input type="number" id="hotelFee" class="w-full bg-slate-50 rounded-lg px-3 py-2 text-sm font-medium outline-none focus:ring-1 focus:ring-primary" value="0" step="0.01">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs text-slate-500">æ‹›å¾…è´¹</label>
                            <input type="number" id="entertainmentFee" class="w-full bg-slate-50 rounded-lg px-3 py-2 text-sm font-medium outline-none focus:ring-1 focus:ring-primary" value="0" step="0.01">
                        </div>
                        <div class="space-y-1 col-span-2">
                            <label class="text-xs text-slate-500">æ‰“è½¦è´¹</label>
                            <input type="number" id="taxiFee" class="w-full bg-slate-50 rounded-lg px-3 py-2 text-sm font-medium outline-none focus:ring-1 focus:ring-primary" value="0" step="0.01">
                        </div>
                    </div>
                </div>

                <!-- ä¸Šä¼ åŒºåŸŸ -->
                <div class="bg-surface p-5 rounded-2xl shadow-soft border border-slate-100">
                    <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">å‘ç¥¨/å°ç¥¨</label>
                    <label class="flex flex-col items-center justify-center w-full h-24 border-2 border-slate-200 border-dashed rounded-xl cursor-pointer hover:bg-slate-50 transition-colors">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <svg class="w-6 h-6 mb-1 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            <p class="text-xs text-slate-500">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</p>
                        </div>
                        <input type="file" id="receipts" multiple accept="image/*,.pdf" class="hidden" onchange="previewFiles()" />
                    </label>
                    <div id="filePreview" class="mt-3 flex flex-wrap gap-2"></div>
                </div>

                <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
                <div class="grid grid-cols-4 gap-3 pt-2">
                    <button onclick="clearForm()" class="col-span-1 py-3 rounded-xl bg-slate-200 text-slate-600 font-semibold text-sm hover:bg-slate-300 transition-colors">
                        æ¸…ç©º
                    </button>
                    <button onclick="saveRecord()" class="col-span-3 py-3 rounded-xl bg-primary text-white font-bold shadow-lg shadow-indigo-500/30 hover:bg-indigo-700 transition-all active:scale-95">
                        ä¿å­˜è®°å½•
                    </button>
                </div>
            </div>

            <!-- 2. å†å²è®°å½•é¡µé¢ -->
            <div id="page-history" class="page hidden fade-in">
                <div class="flex gap-2 mb-4 sticky top-0 bg-bg z-10 py-2">
                    <select id="monthFilter" onchange="loadHistory()" class="flex-1 bg-surface border-none rounded-xl px-4 py-2 text-sm shadow-sm focus:ring-2 focus:ring-primary/20 outline-none text-slate-700 font-medium">
                        <option value="">å…¨éƒ¨æœˆä»½</option>
                    </select>
                    <button onclick="clearAllData()" class="px-4 bg-red-50 text-red-500 rounded-xl text-sm font-bold hover:bg-red-100 transition-colors">
                        æ¸…ç©º
                    </button>
                </div>
                <div id="historyList" class="space-y-3 pb-4">
                    <!-- åˆ—è¡¨é¡¹å°†æ’å…¥è¿™é‡Œ -->
                </div>
            </div>

            <!-- 3. å¯¼å‡ºé¡µé¢ -->
            <div id="page-export" class="page hidden fade-in">
                <div class="bg-surface p-6 rounded-2xl shadow-soft border border-slate-100 mb-4">
                    <h2 class="text-lg font-bold text-slate-800 mb-4">æ•°æ®å¯¼å‡º</h2>
                    <div class="mb-4">
                        <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">é€‰æ‹©æœˆä»½</label>
                        <input type="month" id="exportMonth" class="w-full bg-slate-50 border-none rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-primary/20" onchange="calculateSummary()">
                    </div>
                    <div id="summaryDisplay" class="space-y-3">
                        <!-- ç»Ÿè®¡æ•°æ® -->
                    </div>
                </div>
                <button onclick="exportToExcel()" class="w-full py-4 rounded-xl bg-emerald-500 text-white font-bold shadow-lg shadow-emerald-500/30 hover:bg-emerald-600 transition-all active:scale-95 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    å¯¼å‡º Excel æŠ¥è¡¨
                </button>
            </div>

            <!-- 4. è®¾ç½®é¡µé¢ -->
            <div id="page-settings" class="page hidden fade-in">
                <div class="bg-surface p-6 rounded-2xl shadow-soft border border-slate-100 mb-4">
                    <h2 class="text-lg font-bold text-slate-800 mb-4">ç³»ç»Ÿè®¾ç½®</h2>
                    <div class="mb-6">
                        <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">æ²¹è¡¥å•ä»· (å…ƒ/km)</label>
                        <div class="flex items-center gap-3">
                            <input type="number" id="fuelPrice" step="0.1" class="flex-1 bg-slate-50 border-none rounded-xl px-4 py-3 text-lg font-bold outline-none focus:ring-2 focus:ring-primary/20">
                        </div>
                    </div>
                    <button onclick="saveSettings()" class="w-full py-3 rounded-xl bg-slate-800 text-white font-semibold hover:bg-slate-900 transition-colors mb-4">
                        ä¿å­˜è®¾ç½®
                    </button>
                    
                    <!-- æ–°å¢ï¼šé€€å‡ºç™»å½•æŒ‰é’® -->
                    <button onclick="handleLogout()" class="w-full py-3 rounded-xl bg-red-50 text-red-600 font-semibold hover:bg-red-100 border border-red-100 transition-colors">
                        é€€å‡ºç™»å½•
                    </button>
                </div>

                <div class="mt-6 p-4 bg-emerald-50 rounded-2xl border border-emerald-100 flex items-start gap-3">
                    <div class="text-emerald-500 mt-0.5">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    </div>
                    <div>
                        <p class="text-sm font-bold text-emerald-800">äº‘ç«¯åŒæ­¥å·²å¼€å¯</p>
                        <p class="text-xs text-emerald-600 mt-1">æ•°æ®å®æ—¶ä¿å­˜è‡³ LeanCloudï¼Œæ¢è®¾å¤‡ä¸ä¸¢å¤±ã€‚</p>
                    </div>
                </div>
            </div>
            <!-- 5. å¹´åº¦ç»Ÿè®¡é¡µé¢ -->
            <div id="page-statistics" class="page hidden fade-in">
                <div class="bg-surface p-6 rounded-2xl shadow-soft border border-slate-100 mb-4">
                    <h2 class="text-lg font-bold text-slate-800 mb-4">å¹´åº¦æŠ¥é”€ç»Ÿè®¡</h2>
                    <div class="mb-4">
                        <label class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">é€‰æ‹©å¹´ä»½</label>
                        <select id="yearFilter" onchange="loadAnnualStatistics()" class="w-full bg-slate-50 border-none rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-primary/20 font-medium text-slate-700">
                            <!-- JSä¼šè‡ªåŠ¨å¡«å……å¹´ä»½ -->
                        </select>
                    </div>
                    
                    <!-- å¹´åº¦æ€»è®¡å¡ç‰‡ -->
                    <div class="bg-indigo-600 rounded-xl p-6 text-white text-center shadow-lg shadow-indigo-500/30 mb-6">
                        <div class="text-xs text-indigo-200 mb-1">å¹´åº¦æ€»æŠ¥é”€é‡‘é¢</div>
                        <div class="text-3xl font-bold" id="yearTotalDisplay">Â¥0.00</div>
                    </div>

                    <!-- è¯¦ç»†æ•°æ® -->
                    <div id="yearSummaryDisplay" class="space-y-3">
                        <!-- JSç”Ÿæˆå†…å®¹ -->
                    </div>
                </div>
            </div>

        </main>

        <!-- åº•éƒ¨å¯¼èˆªæ  -->
        <nav class="fixed bottom-0 left-0 right-0 mx-auto w-full max-w-md bg-surface border-t border-slate-100 px-6 py-2 pb-safe shadow-nav z-50">
            <ul class="flex justify-between items-center">
                <li>
                    <button onclick="showTab('entry')" id="tab-entry" class="nav-item active flex flex-col items-center gap-1 p-2 w-16 text-slate-400 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        <span class="text-[10px] font-medium">è®°è´¦</span>
                    </button>
                </li>
                <li>
                    <button onclick="showTab('history')" id="tab-history" class="nav-item flex flex-col items-center gap-1 p-2 w-16 text-slate-400 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span class="text-[10px] font-medium">å†å²</span>
                    </button>
                </li>
                <li>
                    <button onclick="showTab('export')" id="tab-export" class="nav-item flex flex-col items-center gap-1 p-2 w-16 text-slate-400 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        <span class="text-[10px] font-medium">å¯¼å‡º</span>
                    </button>
                </li>
                <li>
                    <button onclick="showTab('statistics')" id="tab-statistics" class="nav-item flex flex-col items-center gap-1 p-2 w-16 text-slate-400 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <span class="text-[10px] font-medium">ç»Ÿè®¡</span>
                    </button>
                </li>

                <li>
                    <button onclick="showTab('settings')" id="tab-settings" class="nav-item flex flex-col items-center gap-1 p-2 w-16 text-slate-400 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span class="text-[10px] font-medium">è®¾ç½®</span>
                    </button>
                </li>
                
            </ul>
        </nav>
    </div>

<script>
// ==================== LeanCloud åˆå§‹åŒ– ====================
console.log('ğŸ”„ å¼€å§‹åˆå§‹åŒ–...');

try {
    AV.init({
        appId: "5HchUk1X6axnIvc5z8SeLgfx-gzGzoHsz",           
        appKey: "VqnYUrCemQAtTDn3dxDuK2K8",         
        serverURL: "https://5hchuk1x.lc-cn-n1-shared.com"    
    });
    console.log('âœ… LeanCloud åˆå§‹åŒ–æˆåŠŸ');
    
    // æµ‹è¯•è¿æ¥
    AV.Query.doCloudQuery('SELECT * FROM _User LIMIT 1')
        .then(() => console.log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ'))
        .catch(err => console.log('âš ï¸ è¿æ¥æµ‹è¯•(å¿½ç•¥):', err.message));
        
} catch(e) {
    console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', e);
}

// ==================== ç™»å½•/æ³¨å†Œé€»è¾‘ (æ–°å¢) ====================

// åˆ‡æ¢ç™»å½•/æ³¨å†Œ Tab
function switchAuthTab(type) {
    const loginBtn = document.getElementById('tab-login-btn');
    const regBtn = document.getElementById('tab-register-btn');
    const loginForm = document.getElementById('form-login');
    const regForm = document.getElementById('form-register');
    const msg = document.getElementById('auth-msg');
    
    msg.textContent = ''; // æ¸…ç©ºé”™è¯¯ä¿¡æ¯

    if(type === 'login') {
        loginBtn.className = "flex-1 py-2 text-sm font-bold rounded-lg bg-white text-primary shadow-sm transition-all";
        regBtn.className = "flex-1 py-2 text-sm font-bold rounded-lg text-slate-500 hover:text-slate-700 transition-all";
        loginForm.classList.remove('hidden');
        regForm.classList.add('hidden');
    } else {
        regBtn.className = "flex-1 py-2 text-sm font-bold rounded-lg bg-white text-emerald-600 shadow-sm transition-all";
        loginBtn.className = "flex-1 py-2 text-sm font-bold rounded-lg text-slate-500 hover:text-slate-700 transition-all";
        regForm.classList.remove('hidden');
        loginForm.classList.add('hidden');
    }
}

// å¤„ç†ç™»å½•
async function handleLogin() {
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value.trim();
    const msg = document.getElementById('auth-msg');

    if(!username || !password) {
        msg.textContent = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
        return;
    }

    try {
        const user = await AV.User.logIn(username, password);
        console.log('âœ… ç™»å½•æˆåŠŸ:', user);
        checkLoginState();
    } catch(error) {
        console.error('âŒ ç™»å½•å¤±è´¥:', error);
        if(error.code === 210) {
            msg.textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
        } else if(error.code === 211) {
            msg.textContent = 'ç”¨æˆ·ä¸å­˜åœ¨';
        } else {
            msg.textContent = 'ç™»å½•å¤±è´¥: ' + error.message;
        }
    }
}

// å¤„ç†æ³¨å†Œ
async function handleRegister() {
    const username = document.getElementById('reg-username').value.trim();
    const password = document.getElementById('reg-password').value.trim();
    const msg = document.getElementById('auth-msg');

    if(!username || !password) {
        msg.textContent = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
        return;
    }
    if(password.length < 6) {
        msg.textContent = 'å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä½';
        return;
    }

    try {
        const user = new AV.User();
        user.setUsername(username);
        user.setPassword(password);
        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šå­—æ®µï¼Œå¦‚ email
        await user.signUp();
        console.log('âœ… æ³¨å†ŒæˆåŠŸ');
        // æ³¨å†ŒæˆåŠŸåè‡ªåŠ¨ç™»å½•
        checkLoginState();
    } catch(error) {
        console.error('âŒ æ³¨å†Œå¤±è´¥:', error);
        if(error.code === 202) {
            msg.textContent = 'ç”¨æˆ·åå·²è¢«å ç”¨';
        } else {
            msg.textContent = 'æ³¨å†Œå¤±è´¥: ' + error.message;
        }
    }
}

// å¤„ç†é€€å‡ºç™»å½•
async function handleLogout() {
    if(confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        AV.User.logOut();
        checkLoginState();
    }
}

// æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œæ§åˆ¶ç•Œé¢æ˜¾ç¤º
function checkLoginState() {
    const currentUser = AV.User.current();
    const authView = document.getElementById('auth-view');
    const appView = document.getElementById('app-view');

    if (currentUser) {
        // å·²ç™»å½•
        authView.classList.add('hidden');
        appView.classList.remove('hidden');
        // åªæœ‰ç™»å½•åæ‰åˆå§‹åŒ–ä¸»åº”ç”¨
        initApp();
    } else {
        // æœªç™»å½•
        authView.classList.remove('hidden');
        appView.classList.add('hidden');
    }
}

// ==================== å·¥å…·å‡½æ•° ====================
// æœ¬åœ°å­˜å‚¨å°è£…
function saveToStorage(key, value) {
    localStorage.setItem(key, JSON.stringify(value));
}
function getFromStorage(key) {
    const item = localStorage.getItem(key);
    return item ? JSON.parse(item) : null;
}

// ==================== å…¨å±€å˜é‡ ====================
let currentSettings = { fuelPricePerKm: 1 };
let clientCount = 0;
let uploadedFiles = [];
let editingId = null; // ç”¨äºè®°å½•æ­£åœ¨ç¼–è¾‘çš„è®°å½•IDï¼Œnullè¡¨ç¤ºæ–°å¢
// ==================== å…¨å±€å˜é‡ (æ–°å¢) ====================
// ä½¿ç”¨ Set å­˜å‚¨å®¢æˆ·åï¼Œè‡ªåŠ¨å»é‡ï¼Œæ–¹ä¾¿å¿«é€ŸæŸ¥æ‰¾
let knownClients = new Set(); 

// ==================== å®¢æˆ·è”æƒ³é€»è¾‘ (æ–°å¢) ====================

// 1. ä»äº‘ç«¯åŠ è½½å·²å­˜åœ¨çš„å®¢æˆ·åˆ—è¡¨
async function loadClientOptions() {
    try {
        const currentUser = AV.User.current();
        if(!currentUser) return; // æœªç™»å½•ä¸åŠ è½½

        // æŸ¥è¯¢ Client è¡¨ï¼ŒåªæŸ¥å½“å‰ç”¨æˆ·çš„
        const query = new AV.Query('Client');
        query.equalTo('owner', currentUser);
        query.limit(1000); // é™åˆ¶æœ€å¤š1000ä¸ªå®¢æˆ·
        const results = await query.find();

        // æ¸…ç©ºæ—§æ•°æ®
        knownClients.clear();
        const datalist = document.getElementById('client-suggestions');
        datalist.innerHTML = ''; // æ¸…ç©º HTML é€‰é¡¹

        // å¡«å……æ•°æ®
        results.forEach(obj => {
            const name = obj.get('name');
            if(name) {
                knownClients.add(name);
                
                // æ·»åŠ åˆ° datalist ä¾› HTML ä½¿ç”¨
                const option = document.createElement('option');
                option.value = name;
                datalist.appendChild(option);
            }
        });
        console.log(`âœ… å·²åŠ è½½ ${knownClients.size} ä¸ªå®¢æˆ·è”æƒ³è¯`);
    } catch (error) {
        console.error('åŠ è½½å®¢æˆ·åˆ—è¡¨å¤±è´¥:', error);
    }
}

// 2. ä¿å­˜æŠ¥é”€æ—¶ï¼Œå°†æ–°å®¢æˆ·åŒæ­¥åˆ° Client è¡¨
async function syncClientsToCloud(clients) {
    const currentUser = AV.User.current();
    if(!currentUser) return;

    for (const name of clients) {
        // å¦‚æœè¿™ä¸ªå®¢æˆ·ä¸åœ¨æˆ‘ä»¬çš„å·²çŸ¥åˆ—è¡¨é‡Œï¼Œè¯´æ˜æ˜¯æ–°å®¢æˆ·
        if (!knownClients.has(name)) {
            try {
                const Client = AV.Object.extend('Client');
                const clientObj = new Client();
                clientObj.set('name', name);
                clientObj.set('owner', currentUser); // å…³è”å½“å‰ç”¨æˆ·
                await clientObj.save();
                
                // ä¿å­˜æˆåŠŸåï¼ŒåŠ å…¥æœ¬åœ°ç¼“å­˜å’Œè”æƒ³åˆ—è¡¨ï¼Œæ— éœ€åˆ·æ–°é¡µé¢å³å¯ç”Ÿæ•ˆ
                knownClients.add(name);
                const option = document.createElement('option');
                option.value = name;
                document.getElementById('client-suggestions').appendChild(option);
                
                console.log(`ğŸ†• æ–°å®¢æˆ·å·²å­˜å…¥äº‘ç«¯: ${name}`);
            } catch (e) {
                console.error(`ä¿å­˜å®¢æˆ· ${name} å¤±è´¥:`, e);
            }
        }
    }
}



// ==================== åˆå§‹åŒ– ====================
window.onload = function() {
    console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆ');
    // ä¼˜å…ˆæ£€æŸ¥ç™»å½•çŠ¶æ€
    checkLoginState();
};

// å°†åŸæœ‰çš„åˆå§‹åŒ–é€»è¾‘å°è£…åœ¨ initApp ä¸­
function initApp() {
    const today = new Date();
    document.getElementById('recordDate').value = today.toISOString().split('T')[0];
    
    // æ›´æ–°Headeræ—¥æœŸ
    const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
    document.getElementById('headerDate').textContent = today.toLocaleDateString('zh-CN', options);
    
    loadSettings();
    loadPrevDayInfo();
    addClientField();
    generateMonthOptions();
    showTab('entry');
    // === æ–°å¢ï¼šåŠ è½½å®¢æˆ·è”æƒ³ ===
    loadClientOptions(); 
}

// ==================== æ ‡ç­¾é¡µåˆ‡æ¢ ====================
function showTab(tabName) {
    // éšè—æ‰€æœ‰é¡µé¢
    document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
    // æ˜¾ç¤ºç›®æ ‡é¡µé¢
    document.getElementById('page-' + tabName).classList.remove('hidden');
    
    // æ›´æ–°åº•éƒ¨å¯¼èˆªæ ·å¼
    document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-' + tabName).classList.add('active');

    // é¡µé¢ç‰¹å®šé€»è¾‘
    if(tabName === 'history') loadHistory();
    if(tabName === 'export') loadSummary();
    if(tabName === 'statistics') loadAnnualStatistics();

    // æ»šåŠ¨å›é¡¶éƒ¨
    document.getElementById('mainContainer').scrollTop = 0;
}

// ==================== å®¢æˆ·ç®¡ç† ====================
function addClientField() {
    if(clientCount >= 6) {
        alert('æœ€å¤šæ·»åŠ 6å®¶å®¢æˆ·');
        return;
    }
    clientCount++;
    const container = document.getElementById('clientsContainer');
    const div = document.createElement('div');
    div.className = 'flex gap-2 items-center animate-[fadeIn_0.2s]';
    
    // === ä¿®æ”¹ï¼šinput æ ‡ç­¾å¢åŠ äº† list="client-suggestions" å’Œ autocomplete="off" ===
    div.innerHTML = `
        <input type="text" 
               class="flex-1 bg-slate-50 border-none rounded-lg px-3 py-2 text-sm client-name outline-none focus:ring-1 focus:ring-primary" 
               list="client-suggestions" 
               autocomplete="off"
               placeholder="å®¢æˆ·å…¬å¸åç§° ${clientCount}">
        <button onclick="removeClient(this)" 
                class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
        </button>
    `;
    container.appendChild(div);
}


function removeClient(btn) {
    btn.parentElement.remove();
    clientCount--;
}

// ==================== è®¡ç®—æ€»é‡Œç¨‹ (æ–°å¢) ====================
function calculateTotalMileage() {
    const start = parseFloat(document.getElementById('startMileage').value) || 0;
    const end = parseFloat(document.getElementById('endMileage').value) || 0;
    
    let total = end - start;
    
    // å¦‚æœç®—å‡ºæ¥æ˜¯è´Ÿæ•°ï¼ˆæ¯”å¦‚å›ç¨‹å¡«é”™äº†ï¼‰ï¼Œæš‚æ—¶æ˜¾ç¤ºä¸º0æˆ–è€…è´Ÿæ•°ï¼Œè¿™é‡Œè®¾ä¸ºè´Ÿæ•°æé†’ç”¨æˆ·
    // å¦‚æœæƒ³å¼ºåˆ¶ä¸º0ï¼Œå¯ä»¥ç”¨: if (total < 0) total = 0;
    
    // æ›´æ–°æ€»é‡Œç¨‹æ˜¾ç¤ºæ¡†
    document.getElementById('mileage').value = total;
    
    // è§¦å‘æ²¹è¡¥è®¡ç®—ï¼ˆå› ä¸ºæ€»é‡Œç¨‹å˜äº†ï¼‰
    calculateFuelSubsidy();
}
// ==================== è®¡ç®—æ²¹è¡¥ (ç¼ºå¤±çš„å‡½æ•°) ====================
function calculateFuelSubsidy() {
    // è·å–æ€»é‡Œç¨‹
    const mileage = parseFloat(document.getElementById('mileage').value) || 0;
    // è®¡ç®—ï¼šé‡Œç¨‹ * å•ä»·
    const subsidy = mileage * currentSettings.fuelPricePerKm;
    // æ›´æ–°é¡µé¢ä¸Šçš„æ˜¾ç¤ºæ–‡å­—
    document.getElementById('fuelSubsidyDisplay').textContent = subsidy.toFixed(2);
}


// ==================== åŠ è½½å‰ä¸€å¤©ä¿¡æ¯ ====================
async function loadPrevDayInfo() {
    try {
        const currentDateStr = document.getElementById('recordDate').value;
        const currentDate = new Date(currentDateStr);
        
        const query = new AV.Query('Expense');
        query.lessThan('date', currentDateStr);
        query.descending('date');
        query.limit(1);
        
        const results = await query.find();
        
        const infoDiv = document.getElementById('prevDayInfo');
        if(results.length > 0) {
            const prev = results[0];
            const prevDate = new Date(prev.get('date')).toLocaleDateString('zh-CN', {month:'numeric', day:'numeric'});
            const prevMileage = prev.get('mileage');
            const prevClients = (prev.get('clients') || []).join('ã€') || 'æ— ';
            
            infoDiv.innerHTML = `
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span>${prevDate} è¡Œç¨‹: ${prevMileage}km | ${prevClients}</span>
            `;
        } else {
            infoDiv.innerHTML = `<span>æš‚æ— å‰ä¸€å¤©è®°å½•</span>`;
        }
    } catch(error) {
        console.error('åŠ è½½å‰ä¸€å¤©ä¿¡æ¯å¤±è´¥:', error);
    }
}

// ==================== æ–‡ä»¶é¢„è§ˆ ====================
function previewFiles() {
    const files = document.getElementById('receipts').files;
    const preview = document.getElementById('filePreview');
    preview.innerHTML = '';
    uploadedFiles = [];
    
    Array.from(files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            uploadedFiles.push({
                name: file.name,
                data: e.target.result,
                type: file.type
            });
            
            const div = document.createElement('div');
            div.className = 'relative w-16 h-16 rounded-lg overflow-hidden border border-slate-200 shadow-sm';
            
            if(file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'w-full h-full object-cover';
                div.appendChild(img);
            } else {
                div.innerHTML = `<div class="w-full h-full bg-slate-100 flex items-center justify-center text-xs text-slate-400 text-center px-1 break-all">PDF</div>`;
            }
            preview.appendChild(div);
        };
        reader.readAsDataURL(file);
    });
}

// ==================== ä¿å­˜è®°å½• (ä¿®å¤ç‰ˆ) ====================
async function saveRecord() {
    console.log('ğŸ’¾ å¼€å§‹ä¿å­˜è®°å½•...');
    
    const clientInputs = document.querySelectorAll('.client-name');
    const clients = Array.from(clientInputs)
        .map(input => input.value.trim())
        .filter(name => name);

    // åŒæ­¥æ–°å®¢æˆ·åˆ°äº‘ç«¯
    await syncClientsToCloud(clients); 

    const startMileage = parseFloat(document.getElementById('startMileage').value) || 0;
    const endMileage = parseFloat(document.getElementById('endMileage').value) || 0;
    const mileage = parseFloat(document.getElementById('mileage').value) || 0; // ä½¿ç”¨è‡ªåŠ¨è®¡ç®—åçš„å€¼
    
    const fuelSubsidy = mileage * currentSettings.fuelPricePerKm;

    const Expense = AV.Object.extend('Expense');
    let expense;

    if (editingId) {
        // ä¿®æ”¹æ—§è®°å½•
        expense = AV.Object.createWithoutData('Expense', editingId);
    } else {
        // æ–°å¢è®°å½•
        expense = new Expense();
    }

    expense.set('date', document.getElementById('recordDate').value);
    
    // ä¿å­˜é‡Œç¨‹æ•°æ®
    expense.set('startMileage', startMileage);
    expense.set('endMileage', endMileage);
    expense.set('mileage', mileage);
    
    expense.set('clients', clients);
    expense.set('tollFee', parseFloat(document.getElementById('tollFee').value) || 0);
    expense.set('parkingFee', parseFloat(document.getElementById('parkingFee').value) || 0);
    expense.set('trainFee', parseFloat(document.getElementById('trainFee').value) || 0);
    expense.set('driverFee', parseFloat(document.getElementById('driverFee').value) || 0);
    expense.set('hotelFee', parseFloat(document.getElementById('hotelFee').value) || 0);
    expense.set('entertainmentFee', parseFloat(document.getElementById('entertainmentFee').value) || 0);
    expense.set('taxiFee', parseFloat(document.getElementById('taxiFee').value) || 0);
    expense.set('fuelSubsidy', fuelSubsidy);

    // å¤„ç†å›¾ç‰‡
    if (uploadedFiles.length > 0) {
        const avFiles = uploadedFiles.map(f => new AV.File(f.name, { base64: f.data }));
        expense.set('receipts', avFiles);
    }

    // === å…³é”®ä¿®å¤ï¼šè®¾ç½® ACL æƒé™ ===
    const currentUser = AV.User.current();
    if (currentUser) {
        const acl = new AV.ACL();
        acl.setPublicReadAccess(false); // ç¦æ­¢å…¶ä»–äººæŸ¥çœ‹
        acl.setWriteAccess(currentUser, true); // å…è®¸è‡ªå·±ä¿®æ”¹
        acl.setReadAccess(currentUser, true); // å…è®¸è‡ªå·±æŸ¥çœ‹
        expense.setACL(acl);
    }

    try {
        await expense.save();
        alert(editingId ? 'âœ… ä¿®æ”¹æˆåŠŸï¼' : 'âœ… ä¿å­˜æˆåŠŸï¼');
        console.log('âœ… å·²ä¿å­˜åˆ°äº‘ç«¯');
        clearForm();
        loadPrevDayInfo();
        
        // å¦‚æœæ˜¯åœ¨å†å²é¡µé¢ä¿®æ”¹çš„ï¼Œä¿®æ”¹å®Œåˆ·æ–°å†å²åˆ—è¡¨
        const historyPage = document.getElementById('page-history');
        if(!historyPage.classList.contains('hidden')) {
            loadHistory();
        }
    } catch(error) {
        console.error('âŒ ä¿å­˜å¤±è´¥:', error);
        alert('âš ï¸ ä¿å­˜å¤±è´¥ï¼š' + error.message);
    }
}

// ==================== ä¿®æ”¹è®°å½• (ä¿®å¤ç‰ˆ) ====================
async function editRecord(id) {
    try {
        // 1. ä»äº‘ç«¯è·å–è¯¥æ¡è®°å½•çš„å®Œæ•´æ•°æ®
        const query = new AV.Query('Expense');
        const record = await query.get(id);

        // 2. åˆ‡æ¢åˆ°è®°è´¦é¡µé¢
        showTab('entry');

        // 3. è®¾ç½®å…¨å±€ç¼–è¾‘ID
        editingId = id;

        // 4. å¡«å……è¡¨å•æ•°æ® (è¿™é‡Œä¿®å¤äº†ä¹‹å‰çš„é”™è¯¯ï¼Œåº”è¯¥æ“ä½œ DOM è€Œä¸æ˜¯ expense å¯¹è±¡)
        document.getElementById('recordDate').value = record.get('date');
        
        // === å¡«å……å‡ºå‘å’Œå›ç¨‹é‡Œç¨‹ ===
        document.getElementById('startMileage').value = record.get('startMileage') || 0;
        document.getElementById('endMileage').value = record.get('endMileage') || 0;

        // é‡æ–°è®¡ç®—ä¸€æ¬¡æ€»é‡Œç¨‹æ˜¾ç¤º
        calculateTotalMileage();

        // å¡«å……å®¢æˆ·åˆ—è¡¨
        const clients = record.get('clients') || [];
        const container = document.getElementById('clientsContainer');
        container.innerHTML = ''; // å…ˆæ¸…ç©ºç°æœ‰çš„
        clientCount = 0;
        
        if (clients.length > 0) {
            clients.forEach(c => {
                addClientField(); // åŠ¨æ€æ·»åŠ è¾“å…¥æ¡†
                const inputs = container.querySelectorAll('.client-name');
                inputs[inputs.length - 1].value = c; // å¡«å…¥å€¼
            });
        } else {
            addClientField(); // å¦‚æœæ²¡æœ‰å®¢æˆ·ï¼Œè‡³å°‘ç•™ä¸€ä¸ªç©ºæ¡†
        }

        // å¡«å……è´¹ç”¨
        document.getElementById('tollFee').value = record.get('tollFee') || 0;
        document.getElementById('parkingFee').value = record.get('parkingFee') || 0;
        document.getElementById('trainFee').value = record.get('trainFee') || 0;
        document.getElementById('driverFee').value = record.get('driverFee') || 0;
        document.getElementById('hotelFee').value = record.get('hotelFee') || 0;
        document.getElementById('entertainmentFee').value = record.get('entertainmentFee') || 0;
        document.getElementById('taxiFee').value = record.get('taxiFee') || 0;

        // æ¸…ç©ºæ–‡ä»¶ä¸Šä¼ åŒº
        document.getElementById('receipts').value = '';
        document.getElementById('filePreview').innerHTML = '';
        uploadedFiles = [];
        
    } catch (error) {
        console.error('åŠ è½½è®°å½•å¤±è´¥:', error);
        alert('åŠ è½½å¤±è´¥: ' + error.message);
    }
}


// ==================== æ¸…ç©ºè¡¨å• ====================
function clearForm() {
	editingId = null; 
    document.getElementById('mileage').value = '';
    document.getElementById('clientsContainer').innerHTML = '';
    clientCount = 0;
    addClientField();
    
    ['tollFee', 'parkingFee', 'trainFee', 'driverFee', 
     'hotelFee', 'entertainmentFee', 'taxiFee'].forEach(id => {
        document.getElementById(id).value = '0';
    });
    
    document.getElementById('receipts').value = '';
    document.getElementById('filePreview').innerHTML = '';
    uploadedFiles = [];
    calculateFuelSubsidy();
}

// ==================== è·å–æ‰€æœ‰è®°å½• (è¾…åŠ©å‡½æ•°) ====================
async function getAllRecords() {
    const query = new AV.Query('Expense');
    query.descending('date');
    query.limit(1000);
    
    // ã€å…³é”®ä¿®å¤ã€‘å¼ºåˆ¶åŒ…å« receipts æ•°ç»„ä¸­çš„æ–‡ä»¶è¯¦æƒ…ï¼Œå¦åˆ™åªæœ‰æŒ‡é’ˆæ²¡æœ‰ URL
    query.include('receipts'); 
    
    return await query.find();
}


// ==================== åŠ è½½å†å²è®°å½• ====================
async function loadHistory() {
    console.log('ğŸ“Š åŠ è½½å†å²è®°å½•...');
    
    const monthFilter = document.getElementById('monthFilter').value;
    const listDiv = document.getElementById('historyList');
    listDiv.innerHTML = '<div class="flex justify-center py-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div></div>';
    
    try {
        // è¿™é‡Œä¼šè‡ªåŠ¨ä½¿ç”¨ä¸Šé¢ä¿®æ”¹è¿‡çš„ getAllRecords (åŒ…å« include)
        const results = await getAllRecords();
        
        let filteredResults = results;
        if(monthFilter) {
            filteredResults = results.filter(obj => obj.get('date').startsWith(monthFilter));
        }
        
        if(filteredResults.length === 0) {
            listDiv.innerHTML = '<div class="text-center py-10 text-slate-400">æš‚æ— è®°å½• ğŸƒ</div>';
            return;
        }

        listDiv.innerHTML = filteredResults.map(obj => {
            const record = {
                id: obj.id,
                date: obj.get('date'),
                mileage: obj.get('mileage') || 0,
                clients: obj.get('clients') || [],
                fuelSubsidy: obj.get('fuelSubsidy') || 0,
                tollFee: obj.get('tollFee') || 0,
                parkingFee: obj.get('parkingFee') || 0,
                trainFee: obj.get('trainFee') || 0,
                driverFee: obj.get('driverFee') || 0,
                hotelFee: obj.get('hotelFee') || 0,
                entertainmentFee: obj.get('entertainmentFee') || 0,
                taxiFee: obj.get('taxiFee') || 0
            };
            
            const total = record.fuelSubsidy + record.tollFee + record.parkingFee +
                         record.trainFee + record.driverFee + record.hotelFee +
                         record.entertainmentFee + record.taxiFee;

            // === å›¾ç‰‡å¤„ç†é€»è¾‘ (æœ€ç»ˆç¨³å¥ç‰ˆ) ===
            const receipts = obj.get('receipts') || [];
            let receiptImagesHtml = '';

            if (receipts.length > 0) {
                receiptImagesHtml = `
                    <div class="flex gap-2 mt-3 overflow-x-auto pb-1 no-scrollbar">
                        ${receipts.map(file => {
                            let url = '';
                            
                            // æ‰“å°æ•´ä¸ªæ–‡ä»¶å¯¹è±¡ï¼Œæ–¹ä¾¿æˆ‘ä»¬åœ¨æ§åˆ¶å°æŸ¥çœ‹
                            console.log('ğŸ” å›¾ç‰‡å¯¹è±¡è¯¦æƒ…:', file);

                            try {
                                // 1. å°è¯• AV.File æ ‡å‡†æ–¹æ³• (include åé€šå¸¸èƒ½ç”¨è¿™ä¸ª)
                                if (typeof file.url === 'function') {
                                    url = file.url();
                                }
                                // 2. å°è¯• attributes.url (å¦‚æœè¿˜æ˜¯ AV.Object ç»“æ„)
                                else if (file.attributes && file.attributes.url) {
                                    url = file.attributes.url;
                                }
                                // 3. å°è¯• _serverData.url (å…œåº•)
                                else if (file._serverData && file._serverData.url) {
                                    url = file._serverData.url;
                                }
                                // 4. å°è¯• toJSON()
                                else if (typeof file.toJSON === 'function') {
                                    const json = file.toJSON();
                                    if (json.url) url = json.url;
                                }
                            } catch (e) {
                                console.error('è·å–URLå¼‚å¸¸:', e);
                            }

                            if (url) {
                                return `
                                    <img src="${url}" 
                                         class="w-16 h-16 rounded-lg object-cover border border-slate-200 flex-shrink-0 cursor-pointer hover:opacity-80 transition-opacity"
                                         onclick="window.open('${url}')"
                                         title="ç‚¹å‡»æŸ¥çœ‹å¤§å›¾">
                                `;
                            } else {
                                // è¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼ŸæŠŠå¯¹è±¡çš„ JSON å­—ç¬¦ä¸²æ‰“å°åˆ°æ§åˆ¶å°
                                console.error('âŒ å½»åº•å¤±è´¥ï¼Œå¯¹è±¡JSON:', JSON.stringify(file));
                                return `
                                    <div class="w-16 h-16 rounded-lg bg-slate-100 border border-slate-200 flex items-center justify-center text-slate-400 flex-shrink-0">
                                        ?
                                    </div>
                                `;
                            }
                        }).join('')}
                    </div>
                `;
            }

            return `
                <div class="bg-surface p-4 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <div class="text-xs text-slate-400 font-medium mb-1">${record.date}</div>
                            <div class="text-sm text-slate-600 flex items-center gap-1">
                                <span>ğŸš— ${record.mileage}km</span>
                                ${record.clients.length > 0 ? `<span class="bg-slate-100 px-2 py-0.5 rounded text-xs text-slate-500">${record.clients[0]}${record.clients.length>1?'ç­‰':''}</span>` : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-slate-900">Â¥${total.toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap gap-x-3 gap-y-1 text-xs text-slate-400 mt-2 pt-2 border-t border-dashed border-slate-100">
                        ${record.tollFee > 0 ? `<span>è¿‡è·¯Â¥${record.tollFee}</span>` : ''}
                        ${record.parkingFee > 0 ? `<span>åœè½¦Â¥${record.parkingFee}</span>` : ''}
                        ${record.trainFee > 0 ? `<span>é«˜é“Â¥${record.trainFee}</span>` : ''}
                        ${record.hotelFee > 0 ? `<span>ä½å®¿Â¥${record.hotelFee}</span>` : ''}
                        ${record.entertainmentFee > 0 ? `<span>æ‹›å¾…Â¥${record.entertainmentFee}</span>` : ''}
                    </div>
                    
                    ${receiptImagesHtml}

                    <div class="mt-3 flex justify-end gap-2">
                        <button onclick="editRecord('${record.id}')" class="text-xs px-3 py-1 bg-indigo-50 text-indigo-600 rounded hover:bg-indigo-100 font-medium">
                            ä¿®æ”¹
                        </button>
                        <button onclick="deleteRecord('${record.id}')" class="text-slate-300 hover:text-red-500 transition-colors p-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
    } catch(error) {
        console.error('âŒ åŠ è½½å¤±è´¥:', error);
        listDiv.innerHTML = `<p class="text-red-500 text-center py-10">åŠ è½½å¤±è´¥ï¼š${error.message}</p>`;
    }
}

// ==================== æ¸…ç©ºæ‰€æœ‰æ•°æ® ====================
async function clearAllData() {
    if(!confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
    if(!confirm('âš ï¸ å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦åˆ é™¤æ‰€æœ‰è®°è´¦è®°å½•å—ï¼Ÿ')) return;
    
    try {
        const results = await getAllRecords();
        if(results.length === 0) {
            alert('å½“å‰æ²¡æœ‰æ•°æ®å¯æ¸…é™¤');
            return;
        }
        await AV.Object.destroyAll(results);
        alert('âœ… æ•°æ®å·²æ¸…ç©º');
        loadHistory();
    } catch(error) {
        console.error('æ¸…ç©ºå¤±è´¥:', error);
        alert('æ¸…ç©ºå¤±è´¥ï¼š' + error.message);
    }
}

// ==================== ç”Ÿæˆæœˆä»½é€‰é¡¹ ====================
function generateMonthOptions() {
    const select = document.getElementById('monthFilter');
    const now = new Date();
    
    for(let i = 0; i < 12; i++) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const value = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        const option = document.createElement('option');
        option.value = value;
        option.textContent = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ`;
        select.appendChild(option);
    }
}

// ==================== æ±‡æ€»ç»Ÿè®¡ ====================
function loadSummary() {
    const monthInput = document.getElementById('exportMonth');
    const now = new Date();
    monthInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    calculateSummary();
}

async function calculateSummary() {
    const monthValue = document.getElementById('exportMonth').value;
    const records = await getAllRecords();
    
    const monthRecords = records.filter(r => r.get('date').startsWith(monthValue));
    
    let summary = {
        count: monthRecords.length,
        totalMileage: 0,
        totalFuelSubsidy: 0,
        totalTollFee: 0,
        totalParkingFee: 0,
        totalTrainFee: 0,
        totalDriverFee: 0,
        totalHotelFee: 0,
        totalEntertainmentFee: 0,
        totalTaxiFee: 0
    };

    monthRecords.forEach(r => {
        summary.totalMileage += r.get('mileage') || 0;
        summary.totalFuelSubsidy += r.get('fuelSubsidy') || 0;
        summary.totalTollFee += r.get('tollFee') || 0;
        summary.totalParkingFee += r.get('parkingFee') || 0;
        summary.totalTrainFee += r.get('trainFee') || 0;
        summary.totalDriverFee += r.get('driverFee') || 0;
        summary.totalHotelFee += r.get('hotelFee') || 0;
        summary.totalEntertainmentFee += r.get('entertainmentFee') || 0;
        summary.totalTaxiFee += r.get('taxiFee') || 0;
    });

    const grandTotal = summary.totalFuelSubsidy + summary.totalTollFee + 
                      summary.totalParkingFee + summary.totalTrainFee + 
                      summary.totalDriverFee + summary.totalHotelFee + 
                      summary.totalEntertainmentFee + summary.totalTaxiFee;

    document.getElementById('summaryDisplay').innerHTML = `
        <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="bg-slate-50 p-3 rounded-xl">
                <div class="text-xs text-slate-400">è®°å½•å¤©æ•°</div>
                <div class="font-bold text-slate-700">${summary.count}å¤©</div>
            </div>
            <div class="bg-slate-50 p-3 rounded-xl">
                <div class="text-xs text-slate-400">æ€»é‡Œç¨‹</div>
                <div class="font-bold text-slate-700">${summary.totalMileage}km</div>
            </div>
            <div class="bg-slate-50 p-3 rounded-xl">
                <div class="text-xs text-slate-400">æ²¹è¡¥åˆè®¡</div>
                <div class="font-bold text-slate-700">Â¥${summary.totalFuelSubsidy.toFixed(2)}</div>
            </div>
            <div class="bg-slate-50 p-3 rounded-xl">
                <div class="text-xs text-slate-400">è¿‡è·¯è´¹</div>
                <div class="font-bold text-slate-700">Â¥${summary.totalTollFee.toFixed(2)}</div>
            </div>
            <div class="bg-slate-50 p-3 rounded-xl">
                <div class="text-xs text-slate-400">åœè½¦è´¹</div>
                <div class="font-bold text-slate-700">Â¥${summary.totalParkingFee.toFixed(2)}</div>
            </div>
            <div class="bg-slate-50 p-3 rounded-xl">
                <div class="text-xs text-slate-400">é«˜é“è´¹</div>
                <div class="font-bold text-slate-700">Â¥${summary.totalTrainFee.toFixed(2)}</div>
            </div>
            <div class="bg-slate-50 p-3 rounded-xl">
                <div class="text-xs text-slate-400">ä»£é©¾è´¹</div>
                <div class="font-bold text-slate-700">Â¥${summary.totalDriverFee.toFixed(2)}</div>
            </div>
            <div class="bg-slate-50 p-3 rounded-xl">
                <div class="text-xs text-slate-400">ä½å®¿è´¹</div>
                <div class="font-bold text-slate-700">Â¥${summary.totalHotelFee.toFixed(2)}</div>
            </div>
            <div class="bg-slate-50 p-3 rounded-xl">
                <div class="text-xs text-slate-400">æ‹›å¾…è´¹</div>
                <div class="font-bold text-slate-700">Â¥${summary.totalEntertainmentFee.toFixed(2)}</div>
            </div>
            <div class="bg-slate-50 p-3 rounded-xl">
                <div class="text-xs text-slate-400">æ‰“è½¦è´¹</div>
                <div class="font-bold text-slate-700">Â¥${summary.totalTaxiFee.toFixed(2)}</div>
            </div>
            <div class="col-span-2 bg-indigo-50 p-4 rounded-xl border border-indigo-100 mt-2">
                <div class="text-xs text-indigo-400 mb-1">æœ¬æœˆæ€»è®¡æŠ¥é”€</div>
                <div class="text-2xl font-bold text-indigo-600">Â¥${grandTotal.toFixed(2)}</div>
            </div>
        </div>
    `;
}

// ==================== å¯¼å‡ºExcel ====================
async function exportToExcel() {
    const monthValue = document.getElementById('exportMonth').value;
    const records = await getAllRecords();
    const monthRecords = records.filter(r => r.get('date').startsWith(monthValue))
                               .sort((a, b) => new Date(a.get('date')) - new Date(b.get('date')));
    
    if(monthRecords.length === 0) {
        alert('è¯¥æœˆä»½æš‚æ— æ•°æ®');
        return;
    }

    const data = monthRecords.map(r => {
        const clients = (r.get('clients') || []).join('ã€');
        const startMileage = r.get('startMileage') || 0;
        const endMileage = r.get('endMileage') || 0;
        const fuelSubsidy = r.get('fuelSubsidy') || 0;
        const tollFee = r.get('tollFee') || 0;
        const parkingFee = r.get('parkingFee') || 0;
        const trainFee = r.get('trainFee') || 0;
        const driverFee = r.get('driverFee') || 0;
        const hotelFee = r.get('hotelFee') || 0;
        const entertainmentFee = r.get('entertainmentFee') || 0;
        const taxiFee = r.get('taxiFee') || 0;
        // è®¡ç®—å°è®¡ï¼ˆä½¿ç”¨æ•°æ®åº“å­˜çš„ mileageï¼Œæˆ–è€…é‡æ–°ç®— start-end ä¹Ÿå¯ä»¥ï¼‰
        const totalMileage = r.get('mileage') || 0; 
        
        return {
    'æ—¥æœŸ': new Date(r.get('date')).toLocaleDateString('zh-CN'),
    'å‡ºå‘å…¬é‡Œæ•°': startMileage,
    'å›ç¨‹å…¬é‡Œæ•°': endMileage,
    'å…¬é‡Œæ•°': totalMileage, // è¿™é‡Œçš„ totalMileage å°±æ˜¯å·®å€¼
    // åˆ æ‰ä¸‹é¢è¿™è¡Œé‡å¤çš„ 'å…¬é‡Œæ•°'
    // 'å…¬é‡Œæ•°': r.get('mileage') || 0, 
    'æ‹œè®¿å®¢æˆ·': clients,
    'æ²¹è¡¥': fuelSubsidy,
    'è¿‡è·¯è´¹': tollFee,
    'åœè½¦è´¹': parkingFee,
    'é«˜é“è´¹': trainFee,
    'ä»£é©¾è´¹': driverFee,
    'ä½å®¿è´¹': hotelFee,
    'æ‹›å¾…è´¹': entertainmentFee,
    'æ‰“è½¦è´¹': taxiFee,
    'å°è®¡': fuelSubsidy + tollFee + parkingFee + trainFee + driverFee + hotelFee + entertainmentFee + taxiFee
};

    });

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "æŠ¥é”€æ˜ç»†");
    
    const [year, month] = monthValue.split('-');
    XLSX.writeFile(wb, `æŠ¥é”€è®°å½•_${year}å¹´${month}æœˆ.xlsx`);
    
    console.log('âœ… Excelå¯¼å‡ºæˆåŠŸ');
}

// ==================== è®¾ç½®ç®¡ç† ====================
function loadSettings() {
    const settings = getFromStorage('settings');
    if(settings) {
        currentSettings = settings;
    }
    document.getElementById('fuelPrice').value = currentSettings.fuelPricePerKm;
    calculateFuelSubsidy();
}

function saveSettings() {
    const fuelPrice = parseFloat(document.getElementById('fuelPrice').value);
    
    if(isNaN(fuelPrice) || fuelPrice <= 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ²¹è¡¥å•ä»·');
        return;
    }
    
    currentSettings.fuelPricePerKm = fuelPrice;
    saveToStorage('settings', currentSettings);
    
    alert('âœ… è®¾ç½®ä¿å­˜æˆåŠŸï¼');
    calculateFuelSubsidy();
}
// ==================== å¹´åº¦ç»Ÿè®¡é€»è¾‘ ====================
async function loadAnnualStatistics() {
    const yearSelect = document.getElementById('yearFilter');
    const now = new Date();
    const currentYear = now.getFullYear();
    
    // 1. åˆå§‹åŒ–æˆ–ç”Ÿæˆå¹´ä»½é€‰é¡¹ (åªåšä¸€æ¬¡)
    if(yearSelect.options.length === 0) {
        for(let i = 0; i < 5; i++) {
            const year = currentYear - i;
            const option = document.createElement('option');
            option.value = year;
            option.textContent = `${year}å¹´`;
            yearSelect.appendChild(option);
        }
    }

    const selectedYear = yearSelect.value || currentYear;
    const records = await getAllRecords();
    
    // 2. ç­›é€‰å½“å¹´æ•°æ®
    const yearRecords = records.filter(r => r.get('date').startsWith(selectedYear.toString()));
    
    // 3. è®¡ç®—æ€»å’Œ
    let summary = {
        count: yearRecords.length,
        totalMileage: 0,
        totalFuelSubsidy: 0,
        totalTollFee: 0,
        totalParkingFee: 0,
        totalTrainFee: 0,
        totalDriverFee: 0,
        totalHotelFee: 0,
        totalEntertainmentFee: 0,
        totalTaxiFee: 0
    };

    yearRecords.forEach(r => {
        summary.totalMileage += r.get('mileage') || 0;
        summary.totalFuelSubsidy += r.get('fuelSubsidy') || 0;
        summary.totalTollFee += r.get('tollFee') || 0;
        summary.totalParkingFee += r.get('parkingFee') || 0;
        summary.totalTrainFee += r.get('trainFee') || 0;
        summary.totalDriverFee += r.get('driverFee') || 0;
        summary.totalHotelFee += r.get('hotelFee') || 0;
        summary.totalEntertainmentFee += r.get('entertainmentFee') || 0;
        summary.totalTaxiFee += r.get('taxiFee') || 0;
    });

    const grandTotal = summary.totalFuelSubsidy + summary.totalTollFee + 
                      summary.totalParkingFee + summary.totalTrainFee + 
                      summary.totalDriverFee + summary.totalHotelFee + 
                      summary.totalEntertainmentFee + summary.totalTaxiFee;

    // 4. æ›´æ–°UI
    document.getElementById('yearTotalDisplay').textContent = `Â¥${grandTotal.toFixed(2)}`;
    
    document.getElementById('yearSummaryDisplay').innerHTML = `
        <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="bg-slate-50 p-3 rounded-xl flex justify-between items-center">
                <span class="text-slate-500 text-xs">è®°å½•å¤©æ•°</span>
                <span class="font-bold text-slate-700">${summary.count}å¤©</span>
            </div>
            <div class="bg-slate-50 p-3 rounded-xl flex justify-between items-center">
                <span class="text-slate-500 text-xs">æ€»é‡Œç¨‹</span>
                <span class="font-bold text-slate-700">${summary.totalMileage}km</span>
            </div>
            
            <div class="col-span-2 border-t border-slate-100 my-1"></div>
            
            <div class="bg-slate-50 p-3 rounded-xl flex justify-between items-center">
                <span class="text-slate-500 text-xs">æ²¹è¡¥</span>
                <span class="font-bold text-slate-700">Â¥${summary.totalFuelSubsidy.toFixed(2)}</span>
            </div>
            <div class="bg-slate-50 p-3 rounded-xl flex justify-between items-center">
                <span class="text-slate-500 text-xs">è¿‡è·¯è´¹</span>
                <span class="font-bold text-slate-700">Â¥${summary.totalTollFee.toFixed(2)}</span>
            </div>
            <div class="bg-slate-50 p-3 rounded-xl flex justify-between items-center">
                <span class="text-slate-500 text-xs">åœè½¦è´¹</span>
                <span class="font-bold text-slate-700">Â¥${summary.totalParkingFee.toFixed(2)}</span>
            </div>
            <div class="bg-slate-50 p-3 rounded-xl flex justify-between items-center">
                <span class="text-slate-500 text-xs">é«˜é“è´¹</span>
                <span class="font-bold text-slate-700">Â¥${summary.totalTrainFee.toFixed(2)}</span>
            </div>
            <div class="bg-slate-50 p-3 rounded-xl flex justify-between items-center">
                <span class="text-slate-500 text-xs">ä½å®¿è´¹</span>
                <span class="font-bold text-slate-700">Â¥${summary.totalHotelFee.toFixed(2)}</span>
            </div>
            <div class="bg-slate-50 p-3 rounded-xl flex justify-between items-center">
                <span class="text-slate-500 text-xs">æ‹›å¾…è´¹</span>
                <span class="font-bold text-slate-700">Â¥${summary.totalEntertainmentFee.toFixed(2)}</span>
            </div>
            <div class="bg-slate-50 p-3 rounded-xl flex justify-between items-center col-span-2">
                <span class="text-slate-500 text-xs">å…¶ä»–(ä»£é©¾/æ‰“è½¦)</span>
                <span class="font-bold text-slate-700">Â¥${(summary.totalDriverFee + summary.totalTaxiFee).toFixed(2)}</span>
            </div>
        </div>
    `;
}

console.log('âœ… æ‰€æœ‰å‡½æ•°å®šä¹‰å®Œæˆ');
    </script>
</body>
</html>
